#!/usr/bin/env bash
set -euo pipefail

# Helper to read configuration variables
plugin_read_config() {
  local name="$1"
  local default="${2:-}"
  local var="BUILDKITE_PLUGIN_GCS_RSYNC_$(echo "$name" | tr '[:lower:]' '[:upper:]')"
  var="${var//-/_}"
  echo "${!var:-$default}"
}

BUCKET="$(plugin_read_config bucket)"
SOURCE="$(plugin_read_config source templates)"
PROJECT="$(plugin_read_config project)"
SA_KEY="$(plugin_read_config service-account-key)"
PROJECTNUMBER="$(plugin_read_config project-number)"
WORKLOAD_POOL_NAME="$(plugin_read_config workload-pool-name)"
WORKLOAD_POOL_PROVIDER="$(plugin_read_config workload-pool-provider)"

if [[ -z "$BUCKET" || -z "$PROJECT" || -z "$SA_KEY" ]]; then
  echo "Missing required configuration" >&2
  exit 1
fi

echo "$SA_KEY" > sa-key.json
trap 'rm -f sa-key.json' EXIT

docker run --rm \
  -v "$PWD":/workspace \
  -w /workspace \
  gcr.io/google.com/cloudsdktool/cloud-sdk:slim \
  bash -c "gcloud auth activate-service-account --key-file sa-key.json && gcloud config set project $PROJECT && gsutil -m rsync -r $SOURCE gs://$BUCKET/"
